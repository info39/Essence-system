<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio OS - Billing & AI Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Noto Sans Hebrew New Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX Compilation in Browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Noto Sans Hebrew', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        /** --- DESIGN SYSTEM & API CONFIG --- */
        const DS = {
            colors: {
                primary: "bg-indigo-600",
                primaryHover: "hover:bg-indigo-700",
                status: {
                    unpaid: "bg-slate-100 text-slate-500",
                    pending: "bg-amber-100 text-amber-700",
                    paid: "bg-emerald-100 text-emerald-700",
                    danger: "bg-red-50 text-red-600 border-red-100"
                }
            }
        };

        const apiKey = ""; // Your Gemini API Key
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        const fetchGemini = async (prompt, systemInstruction = "") => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            
            const callApi = async (retryCount = 0) => {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    if (retryCount < 5) {
                        await new Promise(r => setTimeout(r, Math.pow(2, retryCount) * 1000));
                        return callApi(retryCount + 1);
                    }
                    throw error;
                }
            };
            return callApi();
        };

        /** --- ICONS HELPER --- */
        const LucideIcon = ({ name, className = "w-4 h-4" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ class: className });
                }
            }, [name, className]);
            return <span ref={ref} className="inline-block leading-none" />;
        };

        /** --- MAIN APP --- */
        const App = () => {
            const [activeTab, setActiveTab] = useState('logs');
            const [clients, setClients] = useState([
                { id: '1', name: 'סטודיו גלורי', rate: 250, threshold: 1500, terms: 'שוטף 30' },
                { id: '2', name: 'טק-סולושנס', rate: 270, threshold: 800, terms: 'בנק שעות' }
            ]);
            const [logs, setLogs] = useState([
                { id: '101', date: '2023-11-20', clientId: '1', description: 'עיצוב סדרת פוסטים לקמפיין פייסבוק כולל סגירות לדפוס', minutes: 75, status: 'טרם חויב' },
                { id: '102', date: '2023-11-21', clientId: '2', description: 'אופטימיזציה למנועי חיפוש ותיקון באגים ב-Checkout', minutes: 20, status: 'טרם חויב' }
            ]);
            const [tasks, setTasks] = useState([
                { id: 't1', clientId: '1', description: 'שיחת בירור לגבי קמפיין דצמבר', status: 'ממתין לי', date: '2023-11-22' }
            ]);

            const [isClientFormOpen, setIsClientFormOpen] = useState(false);
            const [editingClient, setEditingClient] = useState(null);
            const [filterClient, setFilterClient] = useState('all');
            const [clientToDelete, setClientToDelete] = useState(null);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [isAiPolishing, setIsAiPolishing] = useState(false);

            const [newLog, setNewLog] = useState({ clientId: '', description: '', minutes: '', date: new Date().toISOString().split('T')[0] });
            const [newTodo, setNewTodo] = useState({ clientId: '', description: '', status: 'לביצוע' });
            const [clientForm, setClientForm] = useState({ name: '', rate: 250, threshold: 1000, terms: 'שוטף' });

            const calculateBillableHours = (minutes) => {
                if (!minutes || minutes <= 0) return 0;
                return Math.max(0.5, Math.ceil(minutes / 30) * 0.5);
            };

            const processedLogs = useMemo(() => {
                return logs.map(log => {
                    const client = clients.find(c => c.id === log.clientId) || {};
                    const billableHours = calculateBillableHours(log.minutes);
                    return { ...log, clientName: client.name || 'לקוח הוסר', rate: client.rate || 0, billableHours, totalPrice: billableHours * (client.rate || 0) };
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [logs, clients]);

            const clientSummaries = useMemo(() => {
                return clients.map(client => {
                    const unpaidLogs = processedLogs.filter(l => l.clientId === client.id && l.status !== 'שולם');
                    const totalUnpaid = unpaidLogs.reduce((sum, log) => sum + log.totalPrice, 0);
                    return { ...client, totalUnpaid, isOverThreshold: totalUnpaid >= client.threshold, unpaidCount: unpaidLogs.length };
                });
            }, [processedLogs, clients]);

            const totalUnpaidAll = useMemo(() => clientSummaries.reduce((s, c) => s + c.totalUnpaid, 0), [clientSummaries]);

            const handleAddLog = (e) => {
                e.preventDefault();
                setLogs([{ ...newLog, id: Date.now().toString(), status: 'טרם חויב', minutes: parseInt(newLog.minutes) }, ...logs]);
                setNewLog({ ...newLog, description: '', minutes: '' });
            };

            const polishDescription = async (text, setter) => {
                if (!text) return;
                setIsAiPolishing(true);
                try {
                    const polished = await fetchGemini(`הפוך לתיאור מקצועי: "${text}"`, "אתה עוזר אדמיניסטרטיבי לסטודיו עיצוב.");
                    if (polished) setter(polished.trim());
                } catch (err) { console.error(err); } finally { setIsAiPolishing(false); }
            };

            const generateClientSummary = async (client) => {
                setIsAiLoading(true);
                try {
                    const unpaidLogs = processedLogs.filter(l => l.clientId === client.id && l.status !== 'שולם');
                    const logsText = unpaidLogs.map(l => `- ${l.description} (${l.billableHours} שעות)`).join('\n');
                    const summary = await fetchGemini(`כתוב סיכום לוואטסאפ ל${client.name}. משימות: ${logsText}. סה"כ: ₪${client.totalUnpaid}.`, "מנהל כספים בסטודיו.");
                    setAiResult({ title: `סיכום גבייה: ${client.name}`, text: summary });
                } catch (err) { console.error(err); } finally { setIsAiLoading(false); }
            };

            const filteredLogs = filterClient === 'all' ? processedLogs : processedLogs.filter(l => l.clientId === filterClient);
            const filteredTasks = filterClient === 'all' ? tasks : tasks.filter(t => t.clientId === filterClient);

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans flex flex-col" dir="rtl">
                    <nav className="bg-slate-900 text-white shadow-xl sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4">
                                <div className="bg-indigo-600 p-2 rounded-xl"><LucideIcon name="LayoutDashboard" className="w-6 h-6" /></div>
                                <div>
                                    <h1 className="text-xl font-black uppercase leading-none">STUDIO OS</h1>
                                    <span className="text-[10px] text-indigo-400 font-bold uppercase tracking-widest block mt-1">Billing & AI Management</span>
                                </div>
                            </div>
                            <div className="flex bg-slate-800 p-1 rounded-2xl overflow-hidden">
                                <button onClick={() => setActiveTab('logs')} className={`flex items-center gap-2 px-6 py-2 rounded-xl transition-all font-bold text-sm ${activeTab === 'logs' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                    <LucideIcon name="ClipboardList" className="w-4 h-4" /> יומן עבודה
                                </button>
                                <button onClick={() => setActiveTab('tasks')} className={`flex items-center gap-2 px-6 py-2 rounded-xl transition-all font-bold text-sm ${activeTab === 'tasks' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                    <LucideIcon name="ListTodo" className="w-4 h-4" /> צ'ק-ליסט
                                </button>
                                <button onClick={() => setActiveTab('clients')} className={`flex items-center gap-2 px-6 py-2 rounded-xl transition-all font-bold text-sm ${activeTab === 'clients' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                    <LucideIcon name="Users" className="w-4 h-4" /> לקוחות
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-4 md:p-8 w-full flex-1">
                        {activeTab === 'logs' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in">
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-[1.5rem] border border-slate-200 shadow-sm">
                                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><LucideIcon name="PlusCircle" className="text-indigo-600" /> דיווח עבודה</h2>
                                        <form onSubmit={handleAddLog} className="space-y-4">
                                            <select className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm font-bold" value={newLog.clientId} onChange={(e) => setNewLog({...newLog, clientId: e.target.value})} required>
                                                <option value="">בחר לקוח...</option>
                                                {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                            <div className="relative">
                                                <textarea className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm" rows="3" placeholder="מה התבצע?" value={newLog.description} onChange={(e) => setNewLog({...newLog, description: e.target.value})} required />
                                                <button type="button" onClick={() => polishDescription(newLog.description, (v) => setNewLog(p => ({...p, description: v})))} className="absolute top-2 left-2 text-[10px] font-black text-indigo-600 flex items-center gap-1 bg-white px-2 py-1 rounded-lg border">
                                                    {isAiPolishing ? <LucideIcon name="Loader2" className="animate-spin w-3 h-3" /> : <LucideIcon name="Sparkles" className="w-3 h-3" />} לטיש
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm" placeholder="דקות" value={newLog.minutes} onChange={(e) => setNewLog({...newLog, minutes: e.target.value})} required />
                                                <input type="date" className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-2 py-3 text-xs" value={newLog.date} onChange={(e) => setNewLog({...newLog, date: e.target.value})} />
                                            </div>
                                            <button className="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl uppercase tracking-wide">הוספה ליומן</button>
                                        </form>
                                    </div>
                                    <div className="bg-white p-6 rounded-[1.5rem] border border-slate-200 shadow-sm">
                                        <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">חובות מעל הרף</h3>
                                        <div className="space-y-3">
                                            {clientSummaries.filter(c => c.totalUnpaid > 0).map(c => (
                                                <div key={c.id} className={`p-4 rounded-2xl border flex justify-between items-center ${c.isOverThreshold ? 'bg-red-50 border-red-100' : 'bg-slate-50'}`}>
                                                    <span className="font-bold text-sm">{c.name}</span>
                                                    <span className={`text-sm font-black ${c.isOverThreshold ? 'text-red-600' : 'text-slate-800'}`}>₪{c.totalUnpaid.toLocaleString()}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="lg:col-span-2 space-y-4">
                                    <div className="bg-white rounded-[1.5rem] border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
                                        <table className="w-full text-right min-w-[600px]">
                                            <thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400 tracking-widest border-b">
                                                <tr>
                                                    <th className="px-6 py-4 whitespace-nowrap">תאריך</th>
                                                    <th className="px-6 py-4 whitespace-nowrap">לקוח</th>
                                                    <th className="px-6 py-4">תיאור</th>
                                                    <th className="px-6 py-4 text-center">שעות</th>
                                                    <th className="px-6 py-4 text-center">סה"כ</th>
                                                    <th className="px-6 py-4"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filteredLogs.map(log => (
                                                    <tr key={log.id} className="hover:bg-slate-50">
                                                        <td className="px-6 py-4 text-[10px] font-mono whitespace-nowrap text-slate-400">{log.date}</td>
                                                        <td className="px-6 py-4 font-bold text-sm whitespace-nowrap">{log.clientName}</td>
                                                        <td className="px-6 py-4 text-xs text-slate-600">{log.description}</td>
                                                        <td className="px-6 py-4 text-center font-black text-indigo-600 text-xs">{log.billableHours.toFixed(1)}</td>
                                                        <td className="px-6 py-4 text-center font-black text-sm">₪{log.totalPrice.toLocaleString()}</td>
                                                        <td className="px-6 py-4 text-left">
                                                            <button onClick={() => setLogs(logs.filter(l => l.id !== log.id))} className="text-slate-300 hover:text-red-500"><LucideIcon name="Trash2" /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Other tabs follow the same logic as previous versions */}
                        {activeTab === 'tasks' && <div className="p-20 text-center opacity-30 italic">לשונית משימות - בטעינה...</div>}
                        {activeTab === 'clients' && <div className="p-20 text-center opacity-30 italic">לשונית לקוחות - בטעינה...</div>}
                    </main>

                    <footer className="py-10 text-center opacity-30 text-[10px] font-black uppercase tracking-[0.3em]">
                        © 2025 Boutique Studio OS
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
