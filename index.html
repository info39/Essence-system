<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESSENCE - Studio OS</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind runtime config (CDN)
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Noto Sans Hebrew"', '"Noto Sans Hebrew New"', 'ui-sans-serif', 'system-ui', 'sans-serif']
          },
          boxShadow: {
            soft: '0 10px 30px rgba(2, 6, 23, 0.08)'
          }
        }
      }
    };
  </script>

  <!-- Noto Sans Hebrew New Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@100..900&display=swap" rel="stylesheet" />

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel for JSX Compilation in Browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Lucide Icons (UMD) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      font-family: 'Noto Sans Hebrew', 'Noto Sans Hebrew New', sans-serif;
      background-color: #f8fafc; /* slate-50 */
    }
    .animate-in {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    /* Brand logo sizing (image or svg) */
    .brand-logo img, .brand-logo svg { height: 40px; width: auto; display: block; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    /** --- BRAND ASSETS --- */
    // Put your file here: ./assets/essence-logo.png
    const ESSENCE_LOGO_SRC = "./assets/essence-logo.png";

    /** --- DESIGN SYSTEM & API CONFIG --- */
    const DS = {
      colors: {
        primary: "bg-indigo-600",
        primaryHover: "hover:bg-indigo-700",
        status: {
          unpaid: "bg-slate-100 text-slate-500",
          pending: "bg-amber-100 text-amber-700",
          paid: "bg-emerald-100 text-emerald-700",
          danger: "bg-red-50 text-red-600 border-red-100"
        }
      }
    };

    const apiKey = ""; // client-side key is not recommended for production
    const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

    const fetchGemini = async (prompt, systemInstruction = "") => {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      };

      const callApi = async (retryCount = 0) => {
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          const result = await response.json();
          return result.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (error) {
          if (retryCount < 5) {
            await new Promise(r => setTimeout(r, Math.pow(2, retryCount) * 1000));
            return callApi(retryCount + 1);
          }
          throw error;
        }
      };
      return callApi();
    };

    /**
     * --- LUCIDE ICONS ---
     * Robust rendering strategy for UMD builds:
     * 1) Prefer lucide.createElement(name, attrs) when available.
     * 2) Fallback to data-lucide + lucide.createIcons().
     */
    const LucideIcon = ({ name, className = "w-4 h-4" }) => {
      const ref = useRef(null);

      useEffect(() => {
        if (!ref.current) return;

        ref.current.innerHTML = "";

        if (window.lucide && typeof window.lucide.createElement === 'function') {
          try {
            const svgEl = window.lucide.createElement(name, { class: className, 'aria-hidden': 'true' });
            if (svgEl) ref.current.appendChild(svgEl);
            return;
          } catch (e) {
            console.warn('[LucideIcon] createElement failed, falling back to createIcons()', e);
          }
        }

        try {
          const placeholder = document.createElement('i');
          placeholder.setAttribute('data-lucide', name);
          placeholder.setAttribute('aria-hidden', 'true');
          ref.current.appendChild(placeholder);

          if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons({
              icons: window.lucide.icons,
              attrs: { class: className }
            });
          }
        } catch (e) {
          console.error('[LucideIcon] Unable to render icon', name, e);
        }
      }, [name, className]);

      return <span ref={ref} className="inline-block leading-none" />;
    };

    /** --- SIMPLE RUNTIME TESTS (NO UI IMPACT) --- */
    const runSelfTests = (calculateBillableHours) => {
      const tests = [
        { in: 0, out: 0 },
        { in: -10, out: 0 },
        { in: 1, out: 0.5 },
        { in: 30, out: 0.5 },
        { in: 31, out: 1.0 },
        { in: 60, out: 1.0 },
        { in: 61, out: 1.5 },
        { in: 75, out: 1.5 },
        { in: 90, out: 1.5 },
        { in: 91, out: 2.0 }
      ];

      const failures = [];
      for (const t of tests) {
        const got = calculateBillableHours(t.in);
        if (got !== t.out) failures.push({ input: t.in, expected: t.out, got });
      }

      if (failures.length) {
        console.error('[Studio OS Tests] FAILED', failures);
      } else {
        console.info('[Studio OS Tests] PASSED', tests.length);
      }
    };

    /** --- MAIN APP --- */
    const App = () => {
      const [activeTab, setActiveTab] = useState('logs');
      const [clients, setClients] = useState([
        { id: '1', name: 'סטודיו גלורי', rate: 250, threshold: 1500, terms: 'שוטף 30' },
        { id: '2', name: 'טק-סולושנס', rate: 270, threshold: 800, terms: 'בנק שעות' }
      ]);
      const [logs, setLogs] = useState([
        { id: '101', date: '2023-11-20', clientId: '1', description: 'עיצוב סדרת פוסטים לקמפיין פייסבוק כולל סגירות לדפוס', minutes: 75, status: 'טרם חויב' },
        { id: '102', date: '2023-11-21', clientId: '2', description: 'אופטימיזציה למנועי חיפוש ותיקון באגים ב-Checkout', minutes: 20, status: 'טרם חויב' }
      ]);
      const [tasks, setTasks] = useState([
        { id: 't1', clientId: '1', description: 'שיחת בירור לגבי קמפיין דצמבר', status: 'ממתין לי', date: '2023-11-22' }
      ]);

      const [filterClient, setFilterClient] = useState('all');
      const [isAiLoading, setIsAiLoading] = useState(false);
      const [aiResult, setAiResult] = useState(null);
      const [isAiPolishing, setIsAiPolishing] = useState(false);

      const [newLog, setNewLog] = useState({
        clientId: '',
        description: '',
        minutes: '',
        date: new Date().toISOString().split('T')[0]
      });

      const calculateBillableHours = (minutes) => {
        if (!minutes || minutes <= 0) return 0;
        return Math.max(0.5, Math.ceil(minutes / 30) * 0.5);
      };

      useEffect(() => {
        runSelfTests(calculateBillableHours);
      }, []);

      const processedLogs = useMemo(() => {
        return logs
          .map(log => {
            const client = clients.find(c => c.id === log.clientId) || {};
            const billableHours = calculateBillableHours(log.minutes);
            return {
              ...log,
              clientName: client.name || 'לקוח הוסר',
              rate: client.rate || 0,
              billableHours,
              totalPrice: billableHours * (client.rate || 0)
            };
          })
          .sort((a, b) => new Date(b.date) - new Date(a.date));
      }, [logs, clients]);

      const clientSummaries = useMemo(() => {
        return clients.map(client => {
          const unpaidLogs = processedLogs.filter(l => l.clientId === client.id && l.status !== 'שולם');
          const totalUnpaid = unpaidLogs.reduce((sum, log) => sum + log.totalPrice, 0);
          return {
            ...client,
            totalUnpaid,
            isOverThreshold: totalUnpaid >= client.threshold,
            unpaidCount: unpaidLogs.length
          };
        });
      }, [processedLogs, clients]);

      const handleAddLog = (e) => {
        e.preventDefault();
        setLogs([
          { ...newLog, id: Date.now().toString(), status: 'טרם חויב', minutes: parseInt(newLog.minutes) },
          ...logs
        ]);
        setNewLog({ ...newLog, description: '', minutes: '' });
      };

      const polishDescription = async (text, setter) => {
        if (!text) return;
        setIsAiPolishing(true);
        try {
          const polished = await fetchGemini(
            `הפוך לתיאור מקצועי: "${text}"`,
            "אתה עוזר אדמיניסטרטיבי לסטודיו עיצוב."
          );
          if (polished) setter(polished.trim());
        } catch (err) {
          console.error(err);
        } finally {
          setIsAiPolishing(false);
        }
      };

      const filteredLogs = filterClient === 'all'
        ? processedLogs
        : processedLogs.filter(l => l.clientId === filterClient);

      return (
        <div className="min-h-screen bg-slate-50 text-slate-900 font-sans flex flex-col" dir="rtl">
          <nav className="bg-slate-950 text-white shadow-xl sticky top-0 z-50 border-b border-slate-800/60">
            <div className="max-w-6xl mx-auto px-5 md:px-8 py-3.5 flex flex-col md:flex-row justify-between items-center gap-4">
              <div className="flex items-center gap-4">
                <div className="brand-logo bg-white/95 rounded-2xl px-3 py-2 shadow-soft border border-white/10">
                  <img src={ESSENCE_LOGO_SRC} alt="ESSENCE" className="h-9 md:h-10 w-auto block" loading="eager" />
                </div>
                <div>
                  <h1 className="text-xl font-black leading-none tracking-tight">ESSENCE</h1>
                  <span className="text-[10px] text-indigo-400 font-bold uppercase tracking-widest block mt-1">
                    Studio OS – Billing & AI
                  </span>
                </div>
              </div>

              <div className="flex bg-slate-900/70 p-1.5 rounded-2xl overflow-hidden border border-slate-800/70 shadow-sm">
                <button
                  onClick={() => setActiveTab('logs')}
                  className={`flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all font-bold text-sm ${activeTab === 'logs' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                >
                  <LucideIcon name="ClipboardList" className="w-4 h-4" /> יומן עבודה
                </button>

                <button
                  onClick={() => setActiveTab('tasks')}
                  className={`flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all font-bold text-sm ${activeTab === 'tasks' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                >
                  <LucideIcon name="ListTodo" className="w-4 h-4" /> צ'ק-ליסט
                </button>

                <button
                  onClick={() => setActiveTab('clients')}
                  className={`flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all font-bold text-sm ${activeTab === 'clients' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                >
                  <LucideIcon name="Users" className="w-4 h-4" /> לקוחות
                </button>
              </div>
            </div>
          </nav>

          <main className="max-w-6xl mx-auto p-4 md:p-8 w-full flex-1">
            {activeTab === 'logs' && (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in">
                <div className="space-y-6">
                  <div className="bg-white p-6 rounded-[1.5rem] border border-slate-200 shadow-sm">
                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                      <LucideIcon name="PlusCircle" className="text-indigo-600" /> דיווח עבודה
                    </h2>

                    <form onSubmit={handleAddLog} className="space-y-4">
                      <select
                        className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm font-bold"
                        value={newLog.clientId}
                        onChange={(e) => setNewLog({ ...newLog, clientId: e.target.value })}
                        required
                      >
                        <option value="">בחר לקוח...</option>
                        {clients.map(c => (
                          <option key={c.id} value={c.id}>{c.name}</option>
                        ))}
                      </select>

                      <div className="relative">
                        <textarea
                          className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm"
                          rows="3"
                          placeholder="מה התבצע?"
                          value={newLog.description}
                          onChange={(e) => setNewLog({ ...newLog, description: e.target.value })}
                          required
                        />
                        <button
                          type="button"
                          onClick={() => polishDescription(newLog.description, (v) => setNewLog(p => ({ ...p, description: v })))}
                          className="absolute top-2 left-2 text-[10px] font-black text-indigo-600 flex items-center gap-1 bg-white px-2 py-1 rounded-lg border"
                        >
                          {isAiPolishing ? (
                            <LucideIcon name="Loader2" className="animate-spin w-3 h-3" />
                          ) : (
                            <LucideIcon name="Sparkles" className="w-3 h-3" />
                          )}
                          לטיש
                        </button>
                      </div>

                      <div className="grid grid-cols-2 gap-3">
                        <input
                          type="number"
                          className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm"
                          placeholder="דקות"
                          value={newLog.minutes}
                          onChange={(e) => setNewLog({ ...newLog, minutes: e.target.value })}
                          required
                        />
                        <input
                          type="date"
                          className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-2 py-3 text-xs"
                          value={newLog.date}
                          onChange={(e) => setNewLog({ ...newLog, date: e.target.value })}
                        />
                      </div>

                      <button className="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl uppercase tracking-wide">
                        הוספה ליומן
                      </button>
                    </form>
                  </div>

                  <div className="bg-white p-6 rounded-[1.5rem] border border-slate-200 shadow-sm">
                    <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">חובות מעל הרף</h3>
                    <div className="space-y-3">
                      {clientSummaries.filter(c => c.totalUnpaid > 0).map(c => (
                        <div
                          key={c.id}
                          className={`p-4 rounded-2xl border flex justify-between items-center ${c.isOverThreshold ? 'bg-red-50 border-red-100' : 'bg-slate-50'}`}
                        >
                          <span className="font-bold text-sm">{c.name}</span>
                          <span className={`text-sm font-black ${c.isOverThreshold ? 'text-red-600' : 'text-slate-800'}`}>
                            ₪{c.totalUnpaid.toLocaleString()}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="lg:col-span-2 space-y-4">
                  <div className="bg-white rounded-[1.5rem] border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
                    <table className="w-full text-right min-w-[600px]">
                      <thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400 tracking-widest border-b">
                        <tr>
                          <th className="px-6 py-4 whitespace-nowrap">תאריך</th>
                          <th className="px-6 py-4 whitespace-nowrap">לקוח</th>
                          <th className="px-6 py-4">תיאור</th>
                          <th className="px-6 py-4 text-center">שעות</th>
                          <th className="px-6 py-4 text-center">סה"כ</th>
                          <th className="px-6 py-4"></th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {filteredLogs.map(log => (
                          <tr key={log.id} className="hover:bg-slate-50">
                            <td className="px-6 py-4 text-[10px] font-mono whitespace-nowrap text-slate-400">{log.date}</td>
                            <td className="px-6 py-4 font-bold text-sm whitespace-nowrap">{log.clientName}</td>
                            <td className="px-6 py-4 text-xs text-slate-600">{log.description}</td>
                            <td className="px-6 py-4 text-center font-black text-indigo-600 text-xs">{log.billableHours.toFixed(1)}</td>
                            <td className="px-6 py-4 text-center font-black text-sm">₪{log.totalPrice.toLocaleString()}</td>
                            <td className="px-6 py-4 text-left">
                              <button
                                onClick={() => setLogs(logs.filter(l => l.id !== log.id))}
                                className="text-slate-300 hover:text-red-500"
                                aria-label="מחק רשומה"
                              >
                                <LucideIcon name="Trash2" />
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'tasks' && (
              <div className="p-20 text-center opacity-30 italic">לשונית משימות - בטעינה...</div>
            )}

            {activeTab === 'clients' && (
              <div className="p-20 text-center opacity-30 italic">לשונית לקוחות - בטעינה...</div>
            )}
          </main>

          <footer className="py-10 text-center opacity-30 text-[10px] font-black uppercase tracking-[0.3em]">
            © 2025 ESSENCE
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
